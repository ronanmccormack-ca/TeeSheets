<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Tee Times - Burnaby & Vancouver Courses</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a2e 0%, #2c5530 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #2c5530;
            font-size: 0.9em;
        }

        .control-group input, .control-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #4a7c59;
        }

        .search-btn {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            align-self: flex-end;
            margin-bottom: 2px;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #2c5530;
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .content {
            padding: 30px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c5530;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(44, 85, 48, 0.3);
            border-top: 4px solid #2c5530;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: #721c24;
            margin-bottom: 20px;
        }

        .error-message h3 {
            margin-bottom: 10px;
            color: #dc3545;
        }

        .retry-button {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .retry-button:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-2px);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results h3 {
            color: #2c5530;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .tee-times-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tee-time-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tee-time-card:hover {
            border-color: #4a7c59;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 124, 89, 0.15);
        }

        .tee-time-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2c5530, #4a7c59);
            border-radius: 12px 12px 0 0;
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .course-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c5530;
        }

        .course-badge {
            background: #2c5530;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .tee-time-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .detail-value {
            color: #2c5530;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .time-value {
            font-size: 1rem !important;
            font-weight: bold !important;
        }

        .price-highlight {
            grid-column: 1 / -1;
            background: #e9f5e9 !important;
            text-align: center;
            font-size: 1.1rem;
        }

        .price-highlight .detail-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .book-btn {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            text-decoration: none;
            text-align: center;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .book-btn:hover {
            background: #2c5530;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group input, .control-group select {
                min-width: 100%;
            }
            
            .search-btn {
                align-self: stretch;
            }
            
            .tee-times-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .tee-time-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèåÔ∏è Tee Time Radar</h1>
            <p>Available Bookings - Burnaby & Vancouver Golf Courses</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="searchDate">Date</label>
                <input type="date" id="searchDate" name="searchDate">
            </div>
            
            <div class="control-group">
                <label for="courseFilter">Course</label>
                <select id="courseFilter" name="courseFilter">
                    <option value="all">All Courses</option>
                    <option value="burnaby">Burnaby Only</option>
                    <option value="vancouver">Vancouver Only</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeFilter">Time</label>
                <select id="timeFilter" name="timeFilter">
                    <option value="">Any Time</option>
                    <option value="morning">Morning (6 AM - 12 PM)</option>
                    <option value="afternoon">Afternoon (12 PM - 6 PM)</option>
                    <option value="evening">Evening (6 PM+)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="maxPrice">Max Price ($)</label>
                <input type="number" id="maxPrice" name="maxPrice" placeholder="100.00" step="0.01">
            </div>
            
            <button class="search-btn" onclick="fetchTeeTimesData()">üîç Search</button>
        </div>

        <div class="content">
            <div id="statsSection" class="stats" style="display: none;">
                <div class="stat">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Available</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="courseCount">0</div>
                    <div class="stat-label">Courses</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="priceRange">$0-$0</div>
                    <div class="stat-label">Price Range</div>
                </div>
            </div>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Fetching available tee times...</p>
            </div>

            <div class="error-message" id="errorMessage" style="display: none;">
                <h3>Unable to fetch tee times</h3>
                <p id="errorText"></p>
                <button onclick="fetchTeeTimesData()" class="retry-button">Try Again</button>
            </div>

            <div id="teeTimesContainer">
                <div class="no-results">
                    <h3>üèåÔ∏è‚Äç‚ôÇÔ∏è Ready to find tee times?</h3>
                    <p>Select your preferred date above and click search to see what's available!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTeeTimesData = [];

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatSearchDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            return `${days[date.getDay()]}%20${months[date.getMonth()]}%20${String(date.getDate()).padStart(2, '0')}%20${date.getFullYear()}`;
        }

        function isVancouverCourse(courseName) {
            if (!courseName) return false;
            const lowerName = courseName.toLowerCase();
            return lowerName.includes('langara') || 
                   lowerName.includes('mccleery') || 
                   lowerName.includes('fraserview');
        }

        function applyFilters(teeTimesData) {
            const courseFilter = document.getElementById('courseFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);

            return teeTimesData.filter(teeTime => {
                // Course filter
                if (courseFilter !== 'all') {
                    const isVancouver = isVancouverCourse(teeTime.courseName);
                    if (courseFilter === 'vancouver' && !isVancouver) return false;
                    if (courseFilter === 'burnaby' && isVancouver) return false;
                }

                // Time filter
                if (timeFilter) {
                    const hour = new Date(teeTime.startTime).getHours();
                    if (timeFilter === 'morning' && (hour < 6 || hour >= 12)) return false;
                    if (timeFilter === 'afternoon' && (hour < 12 || hour >= 18)) return false;
                    if (timeFilter === 'evening' && hour < 18) return false;
                }

                // Price filter
                if (maxPrice && teeTime.shItemPrices && teeTime.shItemPrices[0]) {
                    if (teeTime.shItemPrices[0].displayPrice > maxPrice) return false;
                }

                return true;
            });
        }

        async function fetchTeeTimesData() {
            const searchDate = document.getElementById('searchDate').value;
            
            if (!searchDate) {
                showError('Please select a date to search.');
                return;
            }

            const formattedDate = formatSearchDate(searchDate);
            
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('teeTimesContainer').innerHTML = '';

            try {
                const courseFilter = document.getElementById('courseFilter').value;
                let allTeeTimesData = [];
                let errorMessages = [];

                // Fetch based on filter
                if (courseFilter === 'all' || courseFilter === 'burnaby') {
                    try {
                        const burnabyData = await fetchBurnabyTeeTime(formattedDate);
                        if (burnabyData && burnabyData.length > 0) {
                            allTeeTimesData = allTeeTimesData.concat(burnabyData);
                        }
                    } catch (error) {
                        errorMessages.push(`Burnaby: ${error.message}`);
                    }
                }

                if (courseFilter === 'all' || courseFilter === 'vancouver') {
                    try {
                        const vancouverData = await fetchVancouverTeeTime(formattedDate);
                        if (vancouverData && vancouverData.length > 0) {
                            allTeeTimesData = allTeeTimesData.concat(vancouverData);
                        }
                    } catch (error) {
                        errorMessages.push(`Vancouver: ${error.message}`);
                    }
                }

                // Apply additional filters
                const filteredData = applyFilters(allTeeTimesData);

                // Sort by start time
                filteredData.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                currentTeeTimesData = filteredData;
                
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                if (filteredData && filteredData.length > 0) {
                    updateStats(filteredData);
                    renderTeeTimesCards(filteredData);
                } else {
                    // Show no results message
                    const courseText = courseFilter === 'all' ? 'any courses' : 
                                     courseFilter === 'burnaby' ? 'Burnaby courses' : 'Vancouver courses';
                    document.getElementById('teeTimesContainer').innerHTML = `
                        <div class="no-results">
                            <h3>üòî No tee times found</h3>
                            <p>No available tee times found for ${courseText} on ${formatDate(new Date(searchDate + 'T00:00:00'))} with your current filters. Try adjusting your search criteria.</p>
                            ${errorMessages.length > 0 ? `<p style="margin-top: 10px; font-size: 0.9rem;">Errors: ${errorMessages.join(', ')}</p>` : ''}
                        </div>
                    `;
                }

                // Show partial errors if some data was fetched
                if (errorMessages.length > 0 && filteredData.length > 0) {
                    console.warn('Some API calls failed:', errorMessages);
                }

            } catch (error) {
                console.error('Error fetching tee times:', error);
                showError(`Failed to fetch tee times: ${error.message}. This could be due to CORS restrictions or network issues.`);
            }
        }

        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        async function fetchBurnabyTeeTime(formattedDate) {
            const url = `https://golfburnaby.cps.golf/onlineres/onlineapi/api/v1/onlinereservation/TeeTimes?searchDate=${formattedDate}&holes=0&numberOfPlayer=0&courseIds=1%2C2&searchTimeType=0&teeOffTimeMin=0&teeOffTimeMax=23&isChangeTeeOffTime=true&teeSheetSearchView=5&classCode=R&defaultOnlineRate=N&isUseCapacityPricing=false&memberStoreId=1&searchType=1`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'en-CA,en-US;q=0.9,en;q=0.8',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'X-TerminalId': '3',
                    'x-timezoneid': 'America/Vancouver',
                    'x-siteid': '1',
                    'x-requestid': generateRequestId(),
                    'x-moduleid': '7',
                    'x-productid': '1',
                    'x-componentid': '1',
                    'x-websiteid': '68ffa70d-4c31-4511-f6c6-08db3507e474',
                    'x-ismobile': 'false',
                    'x-timezone-offset': '420',
                    'client-id': 'onlineresweb',
                    'x-apiKey': '8ea2914e-cac2-48a7-a3e5-e0f41350bf3a'
                }
            });

            if (!response.ok) {
                throw new Error(`Burnaby API error! status: ${response.status}`);
            }

            return await response.json();
        }

        async function fetchVancouverTeeTime(formattedDate) {
            const url = `https://golfvancouver.cps.golf/onlineres/onlineapi/api/v1/onlinereservation/TeeTimes?searchDate=${formattedDate}&holes=18&numberOfPlayer=0&courseIds=2%2C1%2C3&searchTimeType=0&teeOffTimeMin=0&teeOffTimeMax=23&isChangeTeeOffTime=true&teeSheetSearchView=5&classCode=R&defaultOnlineRate=N&isUseCapacityPricing=false&memberStoreId=1&searchType=1`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'en-CA,en-US;q=0.9,en;q=0.8',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'X-TerminalId': '3',
                    'x-timezoneid': 'America/Vancouver',
                    'x-siteid': '6',
                    'x-requestid': generateRequestId(),
                    'x-moduleid': '7',
                    'x-productid': '1',
                    'x-componentid': '1',
                    'x-websiteid': '2957df8d-a5c0-40e2-6586-08dd13a88838',
                    'x-ismobile': 'false',
                    'x-timezone-offset': '420',
                    'client-id': 'onlineresweb',
                    'x-apiKey': '8ea2914e-cac2-48a7-a3e5-e0f41350bf3a'
                }
            });

            if (!response.ok) {
                throw new Error(`Vancouver API error! status: ${response.status}`);
            }

            return await response.json();
        }

        function generateRequestId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function updateStats(teeTimes) {
            const statsSection = document.getElementById('statsSection');
            const totalCount = document.getElementById('totalCount');
            const courseCount = document.getElementById('courseCount');
            const priceRange = document.getElementById('priceRange');

            if (teeTimes.length === 0) {
                statsSection.style.display = 'none';
                return;
            }

            const prices = teeTimes
                .filter(t => t.shItemPrices && t.shItemPrices[0])
                .map(t => t.shItemPrices[0].displayPrice);
            
            const uniqueCourses = new Set(teeTimes.map(t => t.courseName)).size;
            
            if (prices.length > 0) {
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                priceRange.textContent = `$${minPrice.toFixed(0)}-$${maxPrice.toFixed(0)}`;
            } else {
                priceRange.textContent = 'N/A';
            }

            totalCount.textContent = teeTimes.length;
            courseCount.textContent = uniqueCourses;

            statsSection.style.display = 'flex';
        }

        function createTeeTimeCard(teeTime) {
            const priceInfo = teeTime.shItemPrices && teeTime.shItemPrices[0];
            const price = priceInfo ? `$${priceInfo.displayPrice.toFixed(2)}` : 'N/A';
            
            const card = document.createElement('div');
            card.className = 'tee-time-card';

            card.innerHTML = `
                <div class="course-header">
                    <div class="course-name">${teeTime.courseName}</div>
                    <div class="course-badge">${teeTime.holesDisplay} Holes</div>
                </div>
                
                <div class="tee-time-details">
                    <div class="detail">
                        <span class="detail-label">Time:</span>
                        <span class="detail-value time-value">${formatTime(teeTime.startTime)}</span>
                    </div>
                    <div class="detail">
                        <span class="detail-label">Players:</span>
                        <span class="detail-value">${teeTime.playersDisplay.replace(/\s*GOLFERS?/i, '')}</span>
                    </div>
                    <div class="detail price-highlight">
                        <span class="detail-label">Price:</span>
                        <span class="detail-value">${price}</span>
                    </div>
                </div>
                
                <button class="book-btn" onclick="bookTeeTime('${isVancouverCourse(teeTime.courseName) ? 'vancouver' : 'burnaby'}')">
                    Book This Tee Time
                </button>
            `;

            return card;
        }

        function bookTeeTime(courseType) {
            if (courseType === 'vancouver') {
                window.open('https://golfvancouver.cps.golf/', '_blank');
            } else {
                window.open('https://golfburnaby.cps.golf/', '_blank');
            }
        }

        function renderTeeTimesCards(data) {
            const container = document.getElementById('teeTimesContainer');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>üòî No tee times found</h3>
                        <p>Try adjusting your search criteria.</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'tee-times-grid';

            data.forEach(teeTime => {
                const card = createTeeTimeCard(teeTime);
                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        // Initialize the page with today's date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('searchDate').value = todayString;
            document.getElementById('searchDate').min = todayString;
        });
    </script>
</body>
</html>